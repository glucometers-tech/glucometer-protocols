<!--
SPDX-FileCopyrightText: 2016 The Glucometer Protocols Authors

SPDX-License-Identifier: CC-BY-SA-4.0
-->

# FreeStyle Libre 2

Reverse engineering in progress.


## Important device notes

### USB IDs

| Device            | Vendor ID | Product ID |
| ---               | ---       | ---        |
| FreeStyle Libre 2 | 1a61      | 3950       |

## Protocol

This device uses the [shared HID protocol](shared-hid-protocol.md) used by other
meters in the FreeStyle family, but introduces encryption.

Text commands are sent by the original software as message type `0x21`, with
responses as `0x60`.

## Encryption

The commands sent to Libre 2 devices are encrypted. The encryption covers the 63
bytes remaining following the message type, for most of the message types used
by the device, excluding the pre-initialisation commands (and their replies),
the `0x22` keep-alive command, and the error replies.

The initialization appears to follow a handshake as follows:

<seqdiag>
{
    edge_length = 300;
    span_height = 20;
    default_fontsize = 12;

    software => reader [label = "0x05 QUERY SERIAL", return =  "0x06 SERIAL NUMBER"]

    software -> reader [label = "0x14, 0x11 START AUTHORIZE"]
    software <-- reader [label = "0x33, 0x16 CHALLENGE"]

    software -> reader [label = "0x14, 0x17 CHALLENGE RESPONSE"]
    software <-- reader [label = "0x14, 0x18 UNKNOWN"]

    software -> reader [label = "0x01 INIT"]
    software <-- reader [label = "0x071 INIT COMPLETE"]
}
</seqdiag>

### START AUTHORIZE, CHALLENGE

The START AUTHORIZE message contains nothing but the sub-command itself. Only
the first 8 bytes of the challenge are used by the Abbott software, but 15 bytes
are always sent.

    request-challenge-cmd = %x14 %x01 %x11
    challenge-response = %x33 %x10 %x16 challenge-content padding
    challenge-content = 8OCTET
    padding = 7OCTET

### CHALLENGE RESPONSE

The CHALLENGE RESPONSE message contains the response to the challenge expected
by the device to authorize the requests from the software. The format of the
message is as follows:

    challenge-response-cmd = %x14 %x1A %x17
                             challenge-response-encrypted %x01
                             challenge-response-mac
    challenge-response-encrypted = 16 OCTET
    challenge-response-mac = 8 OCTET

The procedure to calculate the challenge is not currently reversed, but some
useful notes:

 * The authorization keys are generated based on the serial number of the device
   (unclear if actually used) and the strings `"AuthrEnc"`, `"AuthrMac"`.
 * As noted in the START AUTHORIZE section, only 8 bytes from the device are
   used.
 * The `challenge-response-encrypted` buffer is generated by encrypting
   `challenge-content` together with 8 bytes of random.
 * The `challenge-response-mac` is calculated on the first 14-bytes of the
   message, _including the message type, length, and the constant `0x01`_.
